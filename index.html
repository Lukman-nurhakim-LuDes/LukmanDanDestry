<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undangan Pernikahan Digital (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #1a202c; /* Deep Navy/Charcoal */
            --bg-light: #f7fafc; /* Cream */
            --gold: #d4af37;
            --text-dark: #2d3748;
            --text-light: #f7fafc;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            overflow: hidden; /* Sembunyikan scrollbar awal */
            background-color: var(--bg-light);
        }
        .font-cormorant { font-family: 'Cormorant Garamond', serif; }
        .gold-text { color: var(--gold); }
        .hidden { display: none !important; } /* Make sure hidden overrides everything */

        /* Flower Animation */
        .flower-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 9999; }
        .flower {
            position: absolute; top: -10%; font-size: 20px;
            color: var(--gold);
            animation: fall linear infinite; opacity: 0;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0); opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(105vh) rotate(720deg); opacity: 0; }
        }

        /* Lightbox */
        #lightbox { background-color: rgba(0, 0, 0, 0.9); transition: opacity 0.3s ease-in-out; }
        #lightbox img { max-width: 90vw; max-height: 80vh; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b8860b; }

        /* Scroll Animation */
        .animated-section {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .animated-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Input fields for admin */
        .input-text {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            width: 100%;
        }
        .input-text:focus {
            outline: none;
            border-color: var(--gold); /* focus:border-amber-500 */
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25); /* focus:ring-amber-500 */
        }
        .file-input {
            display: block;
            width: 100%;
            padding: 0.5rem 0;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-500 */
        }
        .file-input::file-selector-button {
            margin-right: 1rem; /* mr-4 */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 9999px; /* rounded-full */
            border: 0;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            background-color: #fefcbf; /* bg-amber-50 */
            color: #b45309; /* text-amber-700 */
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .file-input::file-selector-button:hover {
            background-color: #fef3c7; /* hover:bg-amber-100 */
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="flower-container" class="flower-container"></div>
    <!-- Pastikan loading tidak punya class hidden awal -->
    <div id="loading-indicator" class="fixed inset-0 bg-white z-[100] flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2" style="border-color: var(--gold);"></div>
        <p class="mt-4" style="color: var(--gold);">Memuat Undangan...</p>
    </div>

    <!-- Pastikan view lain punya class hidden awal -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-2xl font-bold font-cormorant text-center text-gray-800 mb-6">Admin Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" required>
                </div>
                <button type="submit" class="w-full text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition duration-300" style="background-color: var(--bg-dark); hover:opacity-90;">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
            </form>
            <p class="text-xs text-center mt-4 text-gray-500">Halaman ini hanya untuk pemilik undangan.</p>
        </div>
    </div>
    
    <div id="invitation-view" class="hidden">
        
        <!-- HALAMAN SAMPUL (LANDING PAGE) -->
        <div id="landing-view" class="transition-opacity duration-1000 hidden"> <!-- Pastikan hidden awal -->
            <section id="cover-section" class="relative min-h-screen bg-cover bg-center flex flex-col justify-center items-center text-white text-center p-4" style="background-image: url('https://placehold.co/1080x1920/1a202c/d4af37?text=Foto+Cover');">
                <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                <div class="relative z-10 flex flex-col h-full justify-center">
                    <div class="flex-grow flex flex-col justify-center items-center">
                        <h3 class="text-xl tracking-widest text-white/90">THE WEDDING OF</h3>
                        <h1 id="bride-groom-cover" class="font-cormorant text-6xl md:text-8xl my-4">Pengantin & Pengantin</h1>
                        <p id="wedding-date-cover" class="text-lg">01 Januari 2026</p>
                    </div>
                    <div class="pb-16">
                         <p class="text-sm">Kepada Yth.</p>
                        <p id="guest-name-display" class="text-2xl font-semibold my-2">Bapak/Ibu/Saudara/i</p>
                        <button id="open-invitation-btn" class="mt-4 bg-white/20 backdrop-blur-sm border border-white/30 text-white py-3 px-8 rounded-full hover:bg-white/30 transition duration-300 flex items-center mx-auto">
                            <i data-lucide="book-open" class="w-5 h-5 mr-2"></i>
                            Buka Undangan
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- KONTEN UTAMA UNDANGAN -->
        <main id="main-content-view" class="hidden opacity-0 transition-opacity duration-1000">
            <section class="py-20 px-4 text-center animated-section bg-white">
                 <div class="relative w-full max-w-4xl mx-auto">
                    <p class="text-lg mb-8 leading-relaxed">"Dan di antara tanda-tanda kekuasaan-Nya ialah Dia menciptakan untukmu isteri-isteri dari jenismu sendiri, supaya kamu cenderung dan merasa tenteram kepadanya, dan dijadikan-Nya diantaramu rasa kasih dan sayang." <br> (QS. Ar-Rum: 21)</p>
                    <h2 id="bride-groom-detail" class="font-cormorant text-4xl md:text-5xl gold-text mb-4">Nama Pengantin</h2>
                    <p id="parents-detail" class="mb-12">Putra dari Bapak ... & Ibu ... <br>dan Putri dari Bapak ... & Ibu ...</p>
                </div>
            </section>

             <!-- SEKSI PROFIL MEMPELAI -->
             <section class="py-20 px-4 animated-section bg-light">
                <div class="relative w-full max-w-4xl mx-auto text-center">
                    <!-- Profil Pria -->
                    <div class="mb-12">
                         <div class="mx-auto w-48 h-64 rounded-t-[100px] rounded-b-lg overflow-hidden shadow-lg border-4 border-white">
                            <img id="groom-photo" src="https://placehold.co/400x600/1a202c/d4af37?text=Foto+Pria" class="w-full h-full object-cover">
                        </div>
                        <h3 id="groom-name" class="font-cormorant text-4xl mt-4 gold-text">Nama Mempelai Pria</h3>
                        <p id="groom-info" class="mt-2 text-gray-600">Info tambahan mempelai pria</p>
                        <a id="groom-social-link" href="#" target="_blank" class="inline-block mt-3 opacity-70 hover:opacity-100 transition hidden">
                            <i data-lucide="instagram" class="w-6 h-6 text-gray-800"></i>
                        </a>
                    </div>
    
                    <div class="flex items-center justify-center space-x-4 my-8">
                        <div class="flex-grow h-px bg-gray-300"></div>
                        <i data-lucide="heart" class="w-6 h-6 gold-text"></i>
                        <div class="flex-grow h-px bg-gray-300"></div>
                    </div>
    
                    <!-- Profil Wanita -->
                    <div class="mb-12">
                         <div class="mx-auto w-48 h-64 rounded-t-[100px] rounded-b-lg overflow-hidden shadow-lg border-4 border-white">
                            <img id="bride-photo" src="https://placehold.co/400x600/1a202c/d4af37?text=Foto+Wanita" class="w-full h-full object-cover">
                        </div>
                        <h3 id="bride-name" class="font-cormorant text-4xl mt-4 gold-text">Nama Mempelai Wanita</h3>
                        <p id="bride-info" class="mt-2 text-gray-600">Info tambahan mempelai wanita</p>
                         <a id="bride-social-link" href="#" target="_blank" class="inline-block mt-3 opacity-70 hover:opacity-100 transition hidden">
                            <i data-lucide="instagram" class="w-6 h-6 text-gray-800"></i>
                        </a>
                    </div>
                    
                    <button id="edit-profile-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>
            </section>
            
            <!-- SEKSI DETAIL ACARA -->
            <section class="py-20 px-4 text-center animated-section bg-white">
                <div class="relative w-full max-w-4xl mx-auto">
                    <h3 class="font-cormorant text-3xl gold-text mb-4">Menuju Hari Bahagia</h3>
                    <div id="countdown" class="text-3xl md:text-4xl font-semibold gold-text mb-8 flex justify-center space-x-4">
                        <div><span id="days">00</span><p class="text-sm">Hari</p></div>
                        <div><span id="hours">00</span><p class="text-sm">Jam</p></div>
                        <div><span id="minutes">00</span><p class="text-sm">Menit</p></div>
                        <div><span id="seconds">00</span><p class="text-sm">Detik</p></div>
                    </div>
    
                    <div class="grid md:grid-cols-2 gap-8 text-lg mt-16">
                        <div id="ceremony-details">
                            <h3 class="font-cormorant text-3xl gold-text mb-2">Akad Nikah</h3>
                            <p id="ceremony-date" class="font-semibold">Minggu, 04 Januari 2026</p>
                            <p id="ceremony-time">09:00 - 10:00 WIB</p>
                            <p id="ceremony-location" class="mt-2">Lokasi Akad</p>
                        </div>
                        <div id="reception-details">
                            <h3 class="font-cormorant text-3xl gold-text mb-2">Resepsi</h3>
                            <p id="reception-date" class="font-semibold">Minggu, 04 Januari 2026</p>
                            <p id="reception-time">11:00 - 14:00 WIB</p>
                            <p id="reception-location" class="mt-2">Lokasi Resepsi</p>
                        </div>
                    </div>
                    <a id="map-link" href="#" target="_blank" class="mt-8 inline-block text-white py-2 px-6 rounded-full hover:opacity-90 transition duration-300" style="background-color: var(--bg-dark);">Lihat Peta Lokasi</a>
                    <button id="edit-details-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>
            </section>
    
            <!-- SEKSI KISAH CINTA -->
            <section class="py-20 px-4 animated-section bg-light">
                <div class="relative w-full max-w-4xl mx-auto">
                    <h2 class="font-cormorant text-4xl md:text-5xl gold-text text-center mb-12">Kisah Cinta Kami</h2>
                    <div id="love-story-content" class="text-center leading-relaxed">
                        <p>Cerita cinta kami dimulai di sini...</p>
                    </div>
                     <button id="edit-story-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>
            </section>
    
            <!-- SEKSI GALERI -->
            <section class="py-20 px-4 animated-section bg-white">
                 <div class="relative w-full max-w-6xl mx-auto">
                    <h2 class="font-cormorant text-4xl md:text-5xl gold-text text-center mb-12">Galeri Foto</h2>
                    <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                         <!-- Foto placeholder -->
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+1" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+2" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+3" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+4" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+5" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                         <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+6" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    </div>
                    <button id="edit-gallery-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                 </div>
            </section>
    
            <!-- SEKSI UCAPAN & RSVP -->
            <section class="py-20 px-4 animated-section bg-light">
                <div class="w-full max-w-4xl mx-auto">
                    <h2 class="font-cormorant text-4xl md:text-5xl gold-text text-center mb-12">Ucapan & Doa</h2>
                    <div class="bg-white p-8 rounded-lg shadow-lg">
                        <form id="wish-form">
                            <div class="mb-4">
                                <label for="guest-name" class="block text-sm font-medium text-gray-700">Nama Anda</label>
                                <input type="text" id="guest-name" class="mt-1 block w-full input-text" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700">Konfirmasi Kehadiran</label>
                                <div class="mt-2 flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="attendance" value="Hadir" class="focus:ring-amber-500 h-4 w-4 text-amber-600 border-gray-300" checked>
                                        <span class="ml-2 text-gray-700">Hadir</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="attendance" value="Tidak Hadir" class="focus:ring-amber-500 h-4 w-4 text-amber-600 border-gray-300">
                                        <span class="ml-2 text-gray-700">Tidak Hadir</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="guest-wish" class="block text-sm font-medium text-gray-700">Ucapan Anda</label>
                                <textarea id="guest-wish" rows="4" class="mt-1 block w-full input-text" required></textarea>
                            </div>
                            <button type="submit" class="w-full text-white py-2 px-4 rounded-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition duration-300" style="background-color: var(--bg-dark);">Kirim Ucapan</button>
                        </form>
                    </div>
                    <div id="wishes-list" class="mt-12 max-h-96 overflow-y-auto space-y-4 pr-2">
                        <!-- Daftar ucapan akan muncul di sini -->
                    </div>
                </div>
            </section>
            
            <!-- SEKSI AMPLOP DIGITAL -->
            <section class="py-20 px-4 animated-section bg-white">
                <div class="relative w-full max-w-4xl mx-auto">
                    <h2 class="font-cormorant text-4xl md:text-5xl gold-text text-center mb-4">Amplop Digital</h2>
                    <p class="text-center mb-12 max-w-2xl mx-auto">Tanpa mengurangi rasa hormat, bagi Anda yang ingin memberikan tanda kasih untuk mempelai, bisa melalui virtual account / e-wallet di bawah ini:</p>
                    <div id="gift-cards-container" class="grid md:grid-cols-2 gap-8">
                        <!-- Kartu bank/e-wallet akan muncul di sini -->
                        <div class="bg-gray-50 p-6 rounded-lg shadow-lg text-center border border-gray-200">
                            <h3 class="font-cormorant text-2xl gold-text">Nama Bank/E-Wallet</h3>
                            <p class="mt-4 text-2xl font-semibold text-gray-800">1234567890</p>
                            <p class="mt-1 text-sm text-gray-600">a.n. Nama Pemilik</p>
                            <button class="copy-btn mt-4 bg-gray-800 text-white py-2 px-6 rounded-full hover:bg-gray-700 transition flex items-center justify-center mx-auto" data-account="1234567890">
                                <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                                <span>Salin Rekening</span>
                            </button>
                        </div>
                    </div>
                    <button id="edit-gift-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>
            </section>

            <!-- SEKSI PENUTUP -->
            <section class="py-20 px-4 text-center animated-section bg-light">
                <div class="relative w-full max-w-4xl mx-auto">
                    <p id="closing-text" class="text-lg mb-8 leading-relaxed">Merupakan suatu kehormatan dan kebahagiaan bagi kami sekeluarga, apabila Bapak/Ibu/Saudara/i berkenan hadir untuk memberikan doa restu kepada kedua mempelai. Atas kehadiran dan doa restunya kami ucapkan terima kasih.</p>
                    <p class="font-cormorant text-3xl gold-text">Terima Kasih</p>
                    <h2 id="bride-groom-closing" class="font-cormorant text-4xl md:text-5xl mt-4">Kami yang Berbahagia,<br>Pengantin</h2>
                    <button id="edit-closing-btn" class="admin-only hidden absolute top-0 right-0 bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                        <i data-lucide="edit" class="w-5 h-5 text-gray-700"></i>
                    </button>
                </div>
            </section>
    
            <!-- TOMBOL MELAYANG UNTUK ADMIN & MUSIK -->
            <div class="fixed bottom-4 right-4 flex flex-col items-end space-y-2 z-50">
                 <button id="logout-btn" class="admin-only hidden bg-red-500 text-white p-3 rounded-full shadow-lg hover:bg-red-600 transition">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
                <!-- TOMBOL EDIT FOTO COVER (HALAMAN PERTAMA) -->
                <button id="edit-cover-btn-floating" class="admin-only hidden bg-purple-500 text-white p-3 rounded-full shadow-lg hover:bg-purple-600 transition" title="Ganti Foto Cover">
                    <i data-lucide="image" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <button id="edit-music-btn" class="admin-only hidden bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 transition">
                        <i data-lucide="music" class="w-6 h-6"></i>
                    </button>
                    <button id="music-control-btn" class="text-white p-3 rounded-full shadow-lg hover:opacity-90 transition" style="background-color: var(--bg-dark);">
                        <i id="music-icon" data-lucide="play" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <audio id="background-music" loop></audio>
        </main>
    </div>

    <!-- MODAL-MODAL EDIT -->

    <!-- Modal Edit Profil -->
    <div id="profile-edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Profil Mempelai</h3>
            <form id="profile-edit-form" class="space-y-6">
                <!-- Bagian Pria -->
                <div>
                    <h4 class="text-lg font-semibold border-b pb-2 mb-3 gold-text">Mempelai Pria</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="groomName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="groomName" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="groomInfo" class="block text-sm font-medium text-gray-700">Info (e.g., Anak ke-.. dari..)</label>
                            <input type="text" id="groomInfo" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="groomSocial" class="block text-sm font-medium text-gray-700">Link Instagram (opsional)</label>
                            <input type="url" id="groomSocial" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="groomPhoto" class="block text-sm font-medium text-gray-700">Ganti Foto Pria</label>
                            <input type="file" id="groomPhoto" accept="image/*" class="file-input mt-1">
                        </div>
                    </div>
                </div>
                <!-- Bagian Wanita -->
                <div>
                    <h4 class="text-lg font-semibold border-b pb-2 mb-3 gold-text">Mempelai Wanita</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="brideName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="brideName" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="brideInfo" class="block text-sm font-medium text-gray-700">Info (e.g., Anak ke-.. dari..)</label>
                            <input type="text" id="brideInfo" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="brideSocial" class="block text-sm font-medium text-gray-700">Link Instagram (opsional)</label>
                            <input type="url" id="brideSocial" class="mt-1 block w-full input-text">
                        </div>
                        <div>
                            <label for="bridePhoto" class="block text-sm font-medium text-gray-700">Ganti Foto Wanita</label>
                            <input type="file" id="bridePhoto" accept="image/*" class="file-input mt-1">
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancel-profile-edit" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--bg-dark);">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Edit Teks Umum -->
    <div id="text-edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Edit Teks</h3>
            <form id="text-edit-form">
                <div id="form-fields" class="space-y-4"></div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancel-text-edit" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--bg-dark);">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Upload File (Cover & Musik) -->
    <div id="file-upload-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="file-modal-title" class="text-xl font-bold mb-4">Upload File</h3>
            <form id="file-upload-form">
                <input type="file" id="file-input" class="file-input" required>
                <p class="text-xs text-gray-500 mt-1" id="file-type-info"></p>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-4 hidden">
                    <div id="progress-bar" class="bg-amber-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancel-file-upload" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--bg-dark);">Upload</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Edit Galeri -->
    <div id="gallery-edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6">
            <h3 class="text-xl font-bold mb-4">Edit Galeri Foto</h3>
            <div id="current-gallery-images" class="grid grid-cols-4 gap-2 mb-4 max-h-64 overflow-y-auto"></div>
            <form id="gallery-upload-form">
                <label class="block mb-2 text-sm font-medium text-gray-900" for="gallery-file-input">Upload foto baru (bisa pilih beberapa):</label>
                <input type="file" id="gallery-file-input" multiple accept="image/*" class="file-input">
                <div id="gallery-progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-4 hidden">
                    <div id="gallery-progress-bar" class="bg-amber-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" id="close-gallery-edit" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Lightbox Tampilan Foto -->
    <div id="lightbox" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
        <span id="close-lightbox" class="absolute top-4 right-6 text-white text-4xl cursor-pointer">&times;</span>
        <img id="lightbox-img" src="" alt="Lightbox Image" class="rounded-lg">
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = 'https://mibbvpkxtjjeglgkgqup.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pYmJ2cGt4dGpqZWdsZ2tncXVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDYyMjYsImV4cCI6MjA3NjYyMjIyNn0.W6DH1oUlF8uDlbAHnlim3rSqds8Q75FQTEJ0GiRB4VI';

    // --- INISIALISASI APLIKASI ---
    let supabaseClient;
    try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client initialized successfully.'); // Log sukses inisialisasi
    } catch (e) {
        console.error("Supabase initialization failed. Please check your config.", e);
        if(loadingIndicator) loadingIndicator.innerHTML = '<p class="text-red-500">Konfigurasi Supabase tidak valid. Silakan periksa konsol.</p>';
    }

    const BUCKET_NAME = 'assets';

    // --- ELEMEN DOM ---
    const loadingIndicator = document.getElementById('loading-indicator');
    const loginView = document.getElementById('login-view');
    const invitationView = document.getElementById('invitation-view');
    const landingView = document.getElementById('landing-view');
    const mainContentView = document.getElementById('main-content-view');
    const openInvitationBtn = document.getElementById('open-invitation-btn');
    const guestNameDisplay = document.getElementById('guest-name-display');
    
    // --- STATE GLOBAL ---
    let currentUser = null;
    let invitationData = {};
    let countdownInterval;
    let isDataLoaded = false;

    // --- AUTENTIKASI ---
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log("Auth state change detected:", event); // Log event auth
        const isAdminPath = window.location.hash === '#admin';
        currentUser = session?.user;

        // Sembunyikan semua view dulu
        if(loginView) loginView.classList.add('hidden');
        if(invitationView) invitationView.classList.add('hidden');
        if(landingView) landingView.classList.add('hidden');
        if(mainContentView) mainContentView.classList.add('hidden');


        if (currentUser) { // JIKA ADMIN LOGIN
            console.log("User is logged in (Admin).");
            invitationView.classList.remove('hidden'); // Tampilkan container utama
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));

            // Langsung lewati halaman sampul
            mainContentView.classList.remove('hidden');
            mainContentView.classList.add('opacity-100');
            document.body.style.overflow = 'auto';
            
            loadingIndicator.classList.add('hidden'); // Sembunyikan loading
            console.log("Showing main content for admin.");

            if (!isDataLoaded) {
                console.log("Fetching initial data for admin...");
                await fetchInitialData(); // Tetap load data
                isDataLoaded = true;
                document.querySelectorAll('.animated-section').forEach(section => {
                    observer.observe(section);
                });
            } else {
                console.log("Data already loaded for admin.");
            }
            
        } else { // JIKA TAMU BIASA atau belum login
            console.log("User is not logged in or is a guest.");
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            
            if (isAdminPath) { // Tampilkan login jika di #admin
                console.log("Admin path detected, showing login view.");
                loginView.classList.remove('hidden');
                loadingIndicator.classList.add('hidden'); // Sembunyikan loading
            } else { // Tampilkan halaman sampul publik
                console.log("Public path detected, showing landing view.");
                invitationView.classList.remove('hidden'); // Tampilkan container utama
                landingView.classList.remove('hidden'); // Tampilkan sampul
                loadingIndicator.classList.remove('hidden'); // Tampilkan loading sampai data siap
                
                if (!isDataLoaded) {
                     console.log("Fetching initial data for guest...");
                    await fetchInitialData(); // Load data baru sembunyikan loading di dalam fetch
                    isDataLoaded = true;
                } else {
                     console.log("Data already loaded for guest.");
                     loadingIndicator.classList.add('hidden'); // Sembunyikan jika data sudah ada
                }
            }
        }
        lucide.createIcons(); // Panggil ini setelah view ditentukan
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        console.log("Attempting login...");

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

        if (error) {
            loginError.textContent = 'Email atau password salah.';
            console.error("Login failed:", error);
        } else {
            console.log("Login successful.");
            window.location.hash = ''; // Biarkan onAuthStateChange menangani view
        }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
        console.log("Logging out...");
        await supabaseClient.auth.signOut();
        window.location.hash = '#admin';
        window.location.reload(); 
    });
    
    // --- LOGIKA HALAMAN SAMPUL ---
    function handleGuestName() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const guestName = urlParams.get('to');
            if (guestName) {
                guestNameDisplay.textContent = guestName;
                 console.log("Guest name set:", guestName);
            } else {
                 console.log("No guest name in URL.");
            }
        } catch (e) {
            console.error("Error parsing URL params for guest name:", e);
        }
    }

    openInvitationBtn.addEventListener('click', () => {
         console.log("Open Invitation button clicked.");
        landingView.classList.add('opacity-0');
        
        setTimeout(() => {
            landingView.classList.add('hidden');
            mainContentView.classList.remove('hidden');
            setTimeout(() => mainContentView.classList.add('opacity-100'), 50);
            
            document.body.style.overflow = 'auto'; // Aktifkan scroll
            playMusic();
            document.querySelectorAll('.animated-section').forEach(section => {
                observer.observe(section);
            });
             console.log("Main content view shown.");
        }, 1000); 
    });


    // --- MEMUAT & MENAMPILKAN DATA ---
    async function fetchInitialData() {
        console.log("Fetching invitation data from Supabase...");
        const { data: invData, error: invError } = await supabaseClient.from('invitations').select('*').eq('id', 1).single();
        
        if (invError) {
             console.error("Error fetching invitation data:", invError);
             if(loadingIndicator) loadingIndicator.innerHTML = `<p class="text-red-500">Gagal memuat data undangan. Kesalahan: ${invError.message}</p>`;
             return; // Hentikan jika data utama gagal
        } else if (invData) {
            console.log("Invitation data fetched:", invData);
            invitationData = invData;
            renderInvitation(invitationData);
        } else {
            console.warn("No invitation data found for ID 1.");
             if(loadingIndicator) loadingIndicator.innerHTML = '<p class="text-orange-500">Data undangan belum diisi.</p>';
        }
        
        console.log("Fetching wishes...");
        await fetchWishes();
        
        // Sembunyikan loading setelah semua data tamu (non-admin) dimuat
        if(!currentUser && loadingIndicator) {
            console.log("Hiding loading indicator for guest.");
            loadingIndicator.classList.add('hidden');
        }
    }

    async function fetchWishes() {
        const { data: wishes, error: wishesError } = await supabaseClient.from('wishes').select('*').order('timestamp', { ascending: false }).limit(50);
        
        const wishesList = document.getElementById('wishes-list');
        if (!wishesList) {
             console.error("Element #wishes-list not found.");
             return;
        }
        wishesList.innerHTML = ''; // Kosongkan dulu
        if (wishesError) {
            console.error("Error fetching wishes:", wishesError);
            wishesList.innerHTML = '<p class="text-center text-red-500">Gagal memuat ucapan.</p>';
        } else if (wishes.length === 0) {
            console.log("No wishes found.");
            wishesList.innerHTML = '<p class="text-center text-gray-500">Jadilah yang pertama mengirim ucapan!</p>';
        } else {
            console.log("Wishes fetched:", wishes.length);
            wishes.forEach(wish => {
                const wishElement = document.createElement('div');
                wishElement.className = 'bg-white p-4 rounded-lg shadow';
                const attendanceBadge = wish.status === 'Hadir' 
                    ? `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Hadir</span>`
                    : `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Tidak Hadir</span>`;

                wishElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold" style="color: var(--text-dark);">${escapeHTML(wish.name)}</p>
                        ${attendanceBadge}
                    </div>
                    <p class="text-gray-600 mt-2">${escapeHTML(wish.message)}</p>
                `;
                wishesList.appendChild(wishElement);
            });
        }
    }

    // --- REALTIME (Langsung update jika ada perubahan) ---
     try {
        supabaseClient.channel('public:invitations')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'invitations', filter: 'id=eq.1' }, payload => {
            console.log('Realtime: Invitation data changed!', payload.new);
            invitationData = payload.new;
            renderInvitation(invitationData);
          })
          .subscribe((status) => {
             if (status === 'SUBSCRIBED') {
                 console.log('Subscribed to invitations changes!');
             } else {
                 console.log('Subscription status invitations:', status);
             }
         });

        supabaseClient.channel('public:wishes')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'wishes' }, payload => {
            console.log('Realtime: New wish received!', payload.new);
            fetchWishes(); // Ambil ulang daftar ucapan
          })
          .subscribe((status) => {
             if (status === 'SUBSCRIBED') {
                 console.log('Subscribed to wishes changes!');
             } else {
                 console.log('Subscription status wishes:', status);
             }
         });
    } catch(e) {
        console.error("Error setting up realtime subscriptions:", e);
    }


    function renderInvitation(data) {
        console.log("Rendering invitation data...");
        // Halaman Sampul
        const coverSection = document.getElementById('cover-section');
        if (coverSection) coverSection.style.backgroundImage = `url('${data.coverPhoto || 'https://placehold.co/1080x1920/1a202c/d4af37?text=Foto+Cover'}')`;
        const brideGroomCover = document.getElementById('bride-groom-cover');
        if (brideGroomCover) brideGroomCover.textContent = data.brideGroomNames || 'Pengantin & Pengantin';
        
        // Detail Umum
        const brideGroomDetail = document.getElementById('bride-groom-detail');
        if (brideGroomDetail) brideGroomDetail.textContent = data.brideGroomNames || 'Pengantin & Pengantin';
        const parentsDetail = document.getElementById('parents-detail');
        if (parentsDetail) parentsDetail.innerHTML = `${data.groomParents || 'Putra dari Bapak ... & Ibu ...'}<br>${data.brideParents || 'dan Putri dari Bapak ... & Ibu ...'}`;
        
        // Profil Mempelai
        const groomName = document.getElementById('groom-name');
        if (groomName) groomName.textContent = data.groomName || 'Nama Mempelai Pria';
        const groomInfo = document.getElementById('groom-info');
        if (groomInfo) groomInfo.textContent = data.groomInfo || 'Info tambahan mempelai pria';
        const groomPhoto = document.getElementById('groom-photo');
        if (groomPhoto) groomPhoto.src = data.groomPhoto || 'https://placehold.co/400x600/1a202c/d4af37?text=Foto+Pria';
        const groomSocial = document.getElementById('groom-social-link');
        if(groomSocial) { if(data.groomSocial) { groomSocial.href = data.groomSocial; groomSocial.classList.remove('hidden'); } else { groomSocial.classList.add('hidden'); } }

        const brideName = document.getElementById('bride-name');
        if (brideName) brideName.textContent = data.brideName || 'Nama Mempelai Wanita';
        const brideInfo = document.getElementById('bride-info');
        if (brideInfo) brideInfo.textContent = data.brideInfo || 'Info tambahan mempelai wanita';
        const bridePhoto = document.getElementById('bride-photo');
        if (bridePhoto) bridePhoto.src = data.bridePhoto || 'https://placehold.co/400x600/1a202c/d4af37?text=Foto+Wanita';
        const brideSocial = document.getElementById('bride-social-link');
        if(brideSocial) { if(data.brideSocial) { brideSocial.href = data.brideSocial; brideSocial.classList.remove('hidden'); } else { brideSocial.classList.add('hidden'); } }

        // Detail Acara
        const ceremonyDateStr = data.ceremonyDate || 'Minggu, 04 Januari 2026';
        const ceremonyTimeStr = data.ceremonyTime || '09:00 - 10:00 WIB';

        const ceremonyDateEl = document.getElementById('ceremony-date');
        if (ceremonyDateEl) ceremonyDateEl.textContent = ceremonyDateStr;
        const ceremonyTimeEl = document.getElementById('ceremony-time');
        if (ceremonyTimeEl) ceremonyTimeEl.textContent = ceremonyTimeStr;
        const ceremonyLocationEl = document.getElementById('ceremony-location');
        if (ceremonyLocationEl) ceremonyLocationEl.textContent = data.ceremonyLocation || 'Lokasi Akad';
        const receptionDateEl = document.getElementById('reception-date');
        if (receptionDateEl) receptionDateEl.textContent = data.receptionDate || 'Minggu, 04 Januari 2026';
        const receptionTimeEl = document.getElementById('reception-time');
        if (receptionTimeEl) receptionTimeEl.textContent = data.receptionTime || '11:00 - 14:00 WIB';
        const receptionLocationEl = document.getElementById('reception-location');
        if (receptionLocationEl) receptionLocationEl.textContent = data.receptionLocation || 'Lokasi Resepsi';
        const weddingDateCover = document.getElementById('wedding-date-cover');
        if (weddingDateCover) weddingDateCover.textContent = ceremonyDateStr; // Update tanggal di sampul
        const mapLink = document.getElementById('map-link');
        if (mapLink) mapLink.href = data.mapLink || '#';
        
        // Kisah Cinta
        const loveStoryContent = document.getElementById('love-story-content');
        if (loveStoryContent) loveStoryContent.innerHTML = data.loveStory ? data.loveStory.replace(/\n/g, '<br>') : 'Cerita cinta kami dimulai di sini...';
        
        // Galeri
        const galleryGrid = document.getElementById('gallery-grid');
        if (galleryGrid) {
            galleryGrid.innerHTML = ''; // Kosongkan dulu
            if (data.galleryPhotos && data.galleryPhotos.length > 0) {
                data.galleryPhotos.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square hover:scale-105 transition-transform duration-300';
                    img.onclick = () => openLightbox(url);
                    galleryGrid.appendChild(img);
                });
            } else {
                 // Tampilkan placeholder jika galeri kosong
                 galleryGrid.innerHTML = `
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+1" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+2" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+3" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+4" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+5" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">
                    <img src="https://placehold.co/600x600/f7fafc/d4af37?text=Foto+6" class="w-full h-auto object-cover rounded-lg shadow-md cursor-pointer aspect-square">`;
            }
        }
        
        // Penutup
        const closingText = document.getElementById('closing-text');
        if (closingText) closingText.textContent = data.closingText || 'Merupakan suatu kehormatan...';
        const brideGroomClosing = document.getElementById('bride-groom-closing');
        if (brideGroomClosing) brideGroomClosing.innerHTML = `Kami yang Berbahagia,<br>${data.brideGroomNames || 'Pengantin'}`;
        
        // Musik
        const audio = document.getElementById('background-music');
        if (audio && data.musicUrl && audio.src !== data.musicUrl) {
            audio.src = data.musicUrl;
            console.log("Music URL updated.");
        }
        startCountdown(ceremonyDateStr, ceremonyTimeStr);
        
        // Amplop Digital
        const giftContainer = document.getElementById('gift-cards-container');
        if(giftContainer) {
            giftContainer.innerHTML = ''; // Kosongkan dulu
            let giftAdded = false;
            for (let i = 1; i <= 2; i++) {
                if (data[`giftBankName${i}`] && data[`giftBankAccount${i}`]) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-6 rounded-lg shadow-lg text-center border border-gray-200';
                    card.innerHTML = `
                        <h3 class="font-cormorant text-2xl gold-text">${escapeHTML(data[`giftBankName${i}`])}</h3>
                        <p class="mt-4 text-2xl font-semibold text-gray-800">${escapeHTML(data[`giftBankAccount${i}`])}</p>
                        <p class="mt-1 text-sm text-gray-600">a.n. ${escapeHTML(data[`giftBankHolder${i}`])}</p>
                        <button class="copy-btn mt-4 bg-gray-800 text-white py-2 px-6 rounded-full hover:bg-gray-700 transition flex items-center justify-center mx-auto" data-account="${escapeHTML(data[`giftBankAccount${i}`])}">
                            <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                            <span>Salin Rekening</span>
                        </button>
                    `;
                    giftContainer.appendChild(card);
                    giftAdded = true;
                }
            }
            // Jika tidak ada data amplop, tampilkan placeholder
            if(!giftAdded) {
                giftContainer.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg shadow-lg text-center border border-gray-200 md:col-span-2"> <!-- Span agar ditengah jika ganjil -->
                        <h3 class="font-cormorant text-2xl gold-text">Nama Bank/E-Wallet</h3>
                        <p class="mt-4 text-2xl font-semibold text-gray-800">1234567890</p>
                        <p class="mt-1 text-sm text-gray-600">a.n. Nama Pemilik</p>
                        <button class="copy-btn mt-4 bg-gray-800 text-white py-2 px-6 rounded-full hover:bg-gray-700 transition flex items-center justify-center mx-auto" data-account="1234567890">
                            <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                            <span>Salin Rekening</span>
                        </button>
                    </div>`;
            }
        }
        lucide.createIcons(); // Panggil ulang setelah menambah ikon baru
        console.log("Invitation rendering complete.");
    }

    // --- HITUNG MUNDUR ---
    function startCountdown(dateStr, timeStr) {
        clearInterval(countdownInterval);
        // Format: "Minggu, 04 Januari 2026" dan "09:00 - 10:00 WIB"
        const targetDateTimeStr = `${dateStr} ${timeStr.split(' ')[0]}`;
        const monthMap = { "Januari": 0, "Februari": 1, "Maret": 2, "April": 3, "Mei": 4, "Juni": 5, "Juli": 6, "Agustus": 7, "September": 8, "Oktober": 9, "November": 10, "Desember": 11 };
        
        try {
            const parts = targetDateTimeStr.replace(',', '').split(' '); // [Minggu, 04, Januari, 2026, 09:00]
            const day = parseInt(parts[1]);
            const month = monthMap[parts[2]];
            const year = parseInt(parts[3]);
            const timeParts = parts[4].split(':');
            const hour = parseInt(timeParts[0]);
            const minute = parseInt(timeParts[1]);

            if (isNaN(day) || month === undefined || isNaN(year) || isNaN(hour) || isNaN(minute)) {
                console.error("Invalid date/time format for countdown:", dateStr, timeStr);
                const countdownEl = document.getElementById('countdown');
                if(countdownEl) countdownEl.innerHTML = '<p class="text-2xl font-cormorant">Menghitung...</p>';
                return;
            }

            const targetDate = new Date(year, month, day, hour, minute).getTime();
            
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                const daysEl = document.getElementById('days');
                const hoursEl = document.getElementById('hours');
                const minutesEl = document.getElementById('minutes');
                const secondsEl = document.getElementById('seconds');
                const countdownEl = document.getElementById('countdown');


                if (distance < 0) {
                    clearInterval(countdownInterval);
                     if(countdownEl) countdownEl.innerHTML = '<p class="text-2xl font-cormorant">Acara Telah Berlangsung</p>';
                    return;
                }
                if(daysEl) daysEl.textContent = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
                if(hoursEl) hoursEl.textContent = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                if(minutesEl) minutesEl.textContent = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                if(secondsEl) secondsEl.textContent = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
            }, 1000);
        } catch (e) {
            console.error("Error parsing countdown date:", e);
            const countdownEl = document.getElementById('countdown');
             if(countdownEl) countdownEl.innerHTML = '<p class="text-2xl font-cormorant">Menghitung...</p>';
        }
    }
    
    // --- KONTROL MODAL ---
    const profileEditModal = document.getElementById('profile-edit-modal');
    const textEditModal = document.getElementById('text-edit-modal');
    const fileUploadModal = document.getElementById('file-upload-modal');
    const galleryEditModal = document.getElementById('gallery-edit-modal');
    let currentUploadType = null;
    
    function openTextEditModal(section, title, fields) {
         console.log(`Opening text edit modal for section: ${section}`);
        document.getElementById('modal-title').textContent = title;
        const formFields = document.getElementById('form-fields');
        formFields.innerHTML = '';
        fields.forEach(field => {
            const fieldWrapper = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-gray-700';
            label.htmlFor = `field-${field.id}`;
            label.textContent = field.label;
            let input;
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 5;
            } else {
                input = document.createElement('input');
                input.type = 'text';
            }
            input.id = `field-${field.id}`;
            input.className = 'mt-1 block w-full input-text';
            input.value = invitationData[field.id] || '';
            fieldWrapper.appendChild(label);
            fieldWrapper.appendChild(input);
            formFields.appendChild(fieldWrapper);
        });
        textEditModal.classList.remove('hidden');
    }
    
    document.getElementById('text-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
         console.log("Submitting text edit form...");
        const updatedData = {};
        const inputs = e.target.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            const fieldId = input.id.replace('field-', '');
            updatedData[fieldId] = input.value;
        });
        console.log("Updating data:", updatedData);

        const { error } = await supabaseClient.from('invitations').update(updatedData).eq('id', 1);

        if (error) {
            console.error("Error updating document: ", error);
            alert('Gagal menyimpan perubahan. Cek konsol untuk detail.');
        } else {
             console.log("Text data updated successfully.");
            textEditModal.classList.add('hidden');
        }
    });
    document.getElementById('cancel-text-edit').addEventListener('click', () => {
         console.log("Closing text edit modal.");
         textEditModal.classList.add('hidden');
    });

    // Event Listener untuk tombol-tombol edit
    const editDetailsBtn = document.getElementById('edit-details-btn');
    if(editDetailsBtn) editDetailsBtn.addEventListener('click', () => {
        openTextEditModal('details', 'Edit Detail Acara', [
            { id: 'brideGroomNames', label: 'Nama Kedua Mempelai (e.g., John & Jane)' }, { id: 'groomParents', label: 'Orang Tua Mempelai Pria' }, { id: 'brideParents', label: 'Orang Tua Mempelai Wanita' }, { id: 'ceremonyDate', label: 'Tanggal Akad (e.g., Minggu, 04 Januari 2026)' }, { id: 'ceremonyTime', label: 'Waktu Akad (e.g., 09:00 - 10:00 WIB)' }, { id: 'ceremonyLocation', label: 'Lokasi Akad' }, { id: 'receptionDate', label: 'Tanggal Resepsi' }, { id: 'receptionTime', label: 'Waktu Resepsi' }, { id: 'receptionLocation', label: 'Lokasi Resepsi' }, { id: 'mapLink', label: 'Link Google Maps' },
        ]);
    });
    const editStoryBtn = document.getElementById('edit-story-btn');
    if(editStoryBtn) editStoryBtn.addEventListener('click', () => openTextEditModal('story', 'Edit Kisah Cinta', [{ id: 'loveStory', label: 'Kisah Cinta', type: 'textarea' }]));
    const editClosingBtn = document.getElementById('edit-closing-btn');
    if(editClosingBtn) editClosingBtn.addEventListener('click', () => openTextEditModal('closing', 'Edit Teks Penutup', [{ id: 'closingText', label: 'Teks Penutup', type: 'textarea' }]));
    const editGiftBtn = document.getElementById('edit-gift-btn');
    if(editGiftBtn) editGiftBtn.addEventListener('click', () => {
        openTextEditModal('gift', 'Edit Amplop Digital', [
            { id: 'giftBankName1', label: 'Nama Bank / E-Wallet 1 (e.g., DANA)' }, { id: 'giftBankAccount1', label: 'Nomor Rekening / Telepon 1' }, { id: 'giftBankHolder1', label: 'Atas Nama 1' },
            { id: 'giftBankName2', label: 'Nama Bank / E-Wallet 2 (opsional)' }, { id: 'giftBankAccount2', label: 'Nomor Rekening / Telepon 2 (opsional)' }, { id: 'giftBankHolder2', label: 'Atas Nama 2 (opsional)' },
        ]);
    });

    // --- MODAL EDIT PROFIL ---
    const editProfileBtn = document.getElementById('edit-profile-btn');
    if(editProfileBtn) editProfileBtn.addEventListener('click', () => {
         console.log("Opening profile edit modal.");
        document.getElementById('groomName').value = invitationData.groomName || '';
        document.getElementById('groomInfo').value = invitationData.groomInfo || '';
        document.getElementById('groomSocial').value = invitationData.groomSocial || '';
        document.getElementById('brideName').value = invitationData.brideName || '';
        document.getElementById('brideInfo').value = invitationData.brideInfo || '';
        document.getElementById('brideSocial').value = invitationData.brideSocial || '';
        document.getElementById('groomPhoto').value = '';
        document.getElementById('bridePhoto').value = '';
        profileEditModal.classList.remove('hidden');
    });

    const cancelProfileEditBtn = document.getElementById('cancel-profile-edit');
    if(cancelProfileEditBtn) cancelProfileEditBtn.addEventListener('click', () => {
        console.log("Closing profile edit modal.");
        profileEditModal.classList.add('hidden');
    });

    const profileEditForm = document.getElementById('profile-edit-form');
    if(profileEditForm) profileEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
         console.log("Submitting profile edit form...");
        const groomPhotoFile = document.getElementById('groomPhoto').files[0];
        const bridePhotoFile = document.getElementById('bridePhoto').files[0];

        const updatedData = {
            groomName: document.getElementById('groomName').value,
            groomInfo: document.getElementById('groomInfo').value,
            groomSocial: document.getElementById('groomSocial').value,
            brideName: document.getElementById('brideName').value,
            brideInfo: document.getElementById('brideInfo').value,
            brideSocial: document.getElementById('brideSocial').value,
        };
        console.log("Profile text data:", updatedData);

        const uploadProfilePhoto = async (file, profileType) => {
            if (!file) return null;
             console.log(`Uploading ${profileType} photo...`);
            const filePath = `profile/${profileType}_${Date.now()}.${file.name.split('.').pop()}`;
            const { error: uploadError } = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath, file, { upsert: true });
            if (uploadError) {
                console.error(`Upload failed for ${profileType}:`, uploadError);
                return null;
            }
            const { data: urlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(filePath);
             console.log(`${profileType} photo uploaded: ${urlData.publicUrl}`);
            return urlData.publicUrl;
        };

        const groomPhotoUrl = await uploadProfilePhoto(groomPhotoFile, 'groom');
        if (groomPhotoUrl) updatedData.groomPhoto = groomPhotoUrl;

        const bridePhotoUrl = await uploadProfilePhoto(bridePhotoFile, 'bride');
        if (bridePhotoUrl) updatedData.bridePhoto = bridePhotoUrl;

        console.log("Updating profile data in database:", updatedData);
        const { error: dbError } = await supabaseClient.from('invitations').update(updatedData).eq('id', 1);

        if (dbError) {
            alert('Gagal menyimpan profil. Cek konsol untuk detail.');
            console.error('Profile update failed:', dbError);
        } else {
            alert('Profil berhasil disimpan!');
             console.log("Profile data updated successfully.");
            profileEditModal.classList.add('hidden');
        }
    });

    // --- LOGIKA UPLOAD FILE (COVER & MUSIK) ---
    function openFileUploadModal(type, title, acceptedFiles) {
         console.log(`Opening file upload modal for type: ${type}`);
        currentUploadType = type;
        document.getElementById('file-modal-title').textContent = title;
        document.getElementById('file-type-info').textContent = `File yang diterima: ${acceptedFiles}`;
        const fileInput = document.getElementById('file-input');
        fileInput.accept = acceptedFiles;
        fileInput.value = ''; // Reset input
        document.getElementById('progress-bar-container').classList.add('hidden');
        document.getElementById('progress-bar').style.width = '0%';
        fileUploadModal.classList.remove('hidden');
    }
    
    const cancelFileUploadBtn = document.getElementById('cancel-file-upload');
    if(cancelFileUploadBtn) cancelFileUploadBtn.addEventListener('click', () => {
         console.log("Closing file upload modal.");
         fileUploadModal.classList.add('hidden');
    });
    
    const fileUploadForm = document.getElementById('file-upload-form');
    if(fileUploadForm) fileUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
         console.log("Submitting file upload form...");
        const file = document.getElementById('file-input').files[0];
        if (!file) {
             console.log("No file selected.");
             return;
        }
        console.log("File selected:", file.name);

        let filePath, dataField;
        if (currentUploadType === 'cover') {
            filePath = `coverPhoto.${file.name.split('.').pop()}`;
            dataField = 'coverPhoto';
        } else if (currentUploadType === 'music') {
            filePath = `backgroundMusic.${file.name.split('.').pop()}`;
            dataField = 'musicUrl';
        }
         console.log("Uploading to path:", filePath);

        const { error: uploadError } = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath, file, { upsert: true });

        if (uploadError) {
            console.error('Upload failed:', uploadError);
            alert(`Upload gagal! Error: ${uploadError.message}`); // Tampilkan pesan error
            return;
        }
        console.log("File uploaded successfully.");

        const { data: urlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(filePath);
        const publicURL = `${urlData.publicUrl}?t=${new Date().getTime()}`; // Tambahkan cache-buster
         console.log("Public URL:", publicURL);

        console.log("Updating database with new URL...");
        const { error: dbError } = await supabaseClient.from('invitations').update({ [dataField]: publicURL }).eq('id', 1);

        if (dbError) {
             console.error('DB update failed:', dbError);
             alert(`Upload berhasil, tapi gagal menyimpan link ke database. Error: ${dbError.message}`);
        } else {
             console.log("Database updated successfully.");
            fileUploadModal.classList.add('hidden');
            alert("File berhasil diupload! Mungkin perlu refresh halaman untuk melihat perubahan foto cover.");
        }
    });

    // Event listener untuk tombol edit cover melayang
    const editCoverBtnFloating = document.getElementById('edit-cover-btn-floating');
    if(editCoverBtnFloating) editCoverBtnFloating.addEventListener('click', () => openFileUploadModal('cover', 'Ganti Foto Cover', 'image/*'));
    const editMusicBtn = document.getElementById('edit-music-btn');
    if(editMusicBtn) editMusicBtn.addEventListener('click', () => openFileUploadModal('music', 'Ganti Musik Latar', '.mp3,.wav'));

    // --- LOGIKA EDIT GALERI ---
    const editGalleryBtn = document.getElementById('edit-gallery-btn');
    if(editGalleryBtn) editGalleryBtn.addEventListener('click', () => {
         console.log("Opening gallery edit modal.");
        renderCurrentGalleryImages();
        galleryEditModal.classList.remove('hidden');
    });
    const closeGalleryEditBtn = document.getElementById('close-gallery-edit');
    if(closeGalleryEditBtn) closeGalleryEditBtn.addEventListener('click', () => {
         console.log("Closing gallery edit modal.");
         galleryEditModal.classList.add('hidden');
    });

    function renderCurrentGalleryImages() {
        const container = document.getElementById('current-gallery-images');
        container.innerHTML = '';
        const photos = invitationData.galleryPhotos || [];
        console.log("Rendering current gallery images:", photos.length);
        photos.forEach((url) => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative group'; // Tambah group untuk hover
            imgContainer.innerHTML = `
                <img src="${url}" class="w-full h-24 object-cover rounded">
                <button data-url="${url}" class="delete-gallery-img absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>`;
            container.appendChild(imgContainer);
        });
        lucide.createIcons();
        document.querySelectorAll('.delete-gallery-img').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const urlToDelete = e.currentTarget.dataset.url;
                 console.log("Attempting to delete gallery image:", urlToDelete);
                if (confirm('Anda yakin ingin menghapus foto ini?')) {
                    await deleteGalleryImage(urlToDelete);
                }
            });
        });
    }

    async function deleteGalleryImage(url) {
        let photos = [...(invitationData.galleryPhotos || [])];
        const pathToDelete = url.split(`${BUCKET_NAME}/`)[1].split('?')[0]; // Hapus cache-buster
        console.log("Deleting from storage path:", pathToDelete);
        
        const { error: storageError } = await supabaseClient.storage.from(BUCKET_NAME).remove([pathToDelete]);
        if (storageError) console.error("Error deleting from storage:", storageError); // Log tapi jangan hentikan

        photos = photos.filter(photoUrl => photoUrl !== url);
        console.log("Updating gallery photos in database:", photos);
        const { error: dbError } = await supabaseClient.from('invitations').update({ galleryPhotos: photos }).eq('id', 1);

        if (dbError) {
            alert('Gagal menghapus foto dari database.');
             console.error("Gallery DB update failed after delete:", dbError);
        } else {
            alert('Foto berhasil dihapus.');
             console.log("Gallery photo deleted successfully.");
             // Render ulang gambar di modal setelah hapus
             renderCurrentGalleryImages();
        }
    }
    
    const galleryFileInput = document.getElementById('gallery-file-input');
    if(galleryFileInput) galleryFileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files.length) return;
        console.log(`Uploading ${files.length} gallery photos...`);
        
        let existingPhotos = [...(invitationData.galleryPhotos || [])];
        const uploadPromises = [];
        const progressBarContainer = document.getElementById('gallery-progress-bar-container');
        const progressBar = document.getElementById('gallery-progress-bar');
        progressBarContainer.classList.remove('hidden');
        progressBar.style.width = '0%';

        for (const file of Array.from(files)) {
            const filePath = `gallery/${Date.now()}_${file.name}`;
            uploadPromises.push(
                supabaseClient.storage.from(BUCKET_NAME).upload(filePath, file)
                    .then(({ data, error }) => {
                        if (error) {
                            console.error(`Upload failed for ${file.name}:`, error);
                            return null;
                        }
                        const { data: urlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(data.path);
                        const newUrl = `${urlData.publicUrl}?t=${new Date().getTime()}`;
                         console.log(`Uploaded ${file.name} to ${newUrl}`);
                        return newUrl;
                    })
            );
        }
        
        // Update progress bar (sederhana, hanya setelah semua selesai)
        const newUrls = (await Promise.all(uploadPromises)).filter(url => url !== null);
        progressBar.style.width = '100%';

        if (newUrls.length > 0) {
            existingPhotos.push(...newUrls);
            console.log("Updating gallery photos in database with new URLs:", existingPhotos);
            const { error: dbError } = await supabaseClient.from('invitations').update({ galleryPhotos: existingPhotos }).eq('id', 1);

            if (dbError) {
                alert("Sebagian/semua foto berhasil diupload, tapi gagal update database.");
                 console.error("Gallery DB update failed after upload:", dbError);
            } else {
                alert('Semua foto berhasil diupload!');
                 console.log("Gallery photos updated successfully.");
                 // Render ulang gambar di modal setelah upload
                 renderCurrentGalleryImages();
            }
        } else {
             alert('Tidak ada foto yang berhasil diupload.');
        }

        // Reset input dan progress bar
        document.getElementById('gallery-file-input').value = '';
        setTimeout(() => {
            progressBarContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        }, 1000);
    });

    // --- FORM UCAPAN ---
    const wishForm = document.getElementById('wish-form');
    if(wishForm) wishForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("Submitting wish form...");
        const nameInput = document.getElementById('guest-name');
        const wishInput = document.getElementById('guest-wish');
        const attendanceStatus = document.querySelector('input[name="attendance"]:checked').value;
        
        const { error } = await supabaseClient.from('wishes').insert([
            { name: nameInput.value, message: wishInput.value, status: attendanceStatus }
        ]);

        if (error) {
            console.error("Error adding wish: ", error);
            alert('Gagal mengirim ucapan. Silakan coba lagi.');
        } else {
             console.log("Wish submitted successfully.");
            nameInput.value = '';
            wishInput.value = '';
            alert('Terima kasih atas ucapan dan konfirmasi Anda!');
            // fetchWishes(); // Tidak perlu jika realtime berfungsi
        }
    });

    // --- MUSIK & LIGHTBOX ---
    const musicBtn = document.getElementById('music-control-btn'), musicIcon = document.getElementById('music-icon'), audio = document.getElementById('background-music');
    
    function toggleMusic() { 
        if (!audio) return;
        audio.paused ? playMusic() : pauseMusic(); 
    }
    function playMusic() { 
        if (!audio) return;
        audio.play().then(() => {
            console.log("Music playing.");
            musicIcon.setAttribute('data-lucide', 'pause'); 
            lucide.createIcons();
        }).catch(e => console.log("Autoplay prevented or audio error:", e)); 
    }
    function pauseMusic() { 
        if (!audio) return;
        audio.pause(); 
        console.log("Music paused.");
        musicIcon.setAttribute('data-lucide', 'play'); 
        lucide.createIcons(); 
    }
    if(musicBtn) musicBtn.addEventListener('click', toggleMusic);

    const lightbox = document.getElementById('lightbox'), lightboxImg = document.getElementById('lightbox-img'), closeLightboxBtn = document.getElementById('close-lightbox');
    function openLightbox(src) { 
        console.log("Opening lightbox:", src);
        if(lightboxImg) lightboxImg.src = src; 
        if(lightbox) lightbox.classList.remove('hidden'); 
    }
    function closeLightbox() { 
        console.log("Closing lightbox.");
        if(lightbox) lightbox.classList.add('hidden'); 
    }
    if(closeLightboxBtn) closeLightboxBtn.addEventListener('click', closeLightbox);
    if(lightbox) lightbox.addEventListener('click', (e) => { if (e.target.id === 'lightbox') closeLightbox(); });
    
    // --- UTILITAS ---
    function escapeHTML(str) { 
        if (str === null || str === undefined) return '';
        const p = document.createElement('p'); 
        p.appendChild(document.createTextNode(str)); 
        return p.innerHTML; 
    }
    function createFlowers() { 
        const container = document.getElementById('flower-container');
        if (!container) return;
        const flowerTypes = ['', '', '']; 
        for (let i = 0; i < 25; i++) { 
            const flower = document.createElement('div'); 
            flower.className = 'flower'; 
            flower.textContent = flowerTypes[Math.floor(Math.random() * flowerTypes.length)]; 
            flower.style.left = `${Math.random() * 100}vw`; 
            const duration = Math.random() * 8 + 7; // 7s to 15s
            flower.style.animationDuration = `${duration}s`; 
            flower.style.animationDelay = `${Math.random() * 10}s`; 
            flower.style.fontSize = `${Math.random() * 15 + 10}px`; // 10px to 25px
            container.appendChild(flower); 
        } 
        console.log("Flowers created.");
    }
    
    // Event listener untuk tombol "Salin" (pakai event delegation)
    document.addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn');
        if (copyBtn) {
            const accountNumber = copyBtn.dataset.account;
            console.log("Copy button clicked for account:", accountNumber);
            try {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = accountNumber;
                 // Hindari elemen terlihat
                 tempTextarea.style.position = 'absolute';
                 tempTextarea.style.left = '-9999px';
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                // document.execCommand('copy') mungkin tidak bekerja di semua browser/iframe
                navigator.clipboard.writeText(accountNumber).then(() => {
                    console.log("Account number copied to clipboard.");
                    const btnSpan = copyBtn.querySelector('span');
                    if (btnSpan) btnSpan.textContent = 'Berhasil Disalin!';
                    setTimeout(() => {
                        if (btnSpan) btnSpan.textContent = 'Salin Rekening';
                    }, 2000);
                }).catch(err => {
                     console.error('Failed to copy text using Clipboard API: ', err);
                     // Fallback ke execCommand jika API gagal
                     try {
                        document.execCommand('copy');
                        console.log("Account number copied using execCommand.");
                         const btnSpan = copyBtn.querySelector('span');
                        if (btnSpan) btnSpan.textContent = 'Berhasil Disalin!';
                        setTimeout(() => {
                            if (btnSpan) btnSpan.textContent = 'Salin Rekening';
                        }, 2000);
                     } catch (execErr) {
                         console.error('Failed to copy text using execCommand: ', execErr);
                         alert('Gagal menyalin. Silakan salin secara manual.');
                     }
                });
                document.body.removeChild(tempTextarea);
            } catch (err) {
                 console.error('General error during copy: ', err);
                 alert('Gagal menyalin. Silakan salin secara manual.');
            }
        }
    });

    // --- OBSERVER UNTUK ANIMASI SCROLL ---
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                 // Hentikan observasi setelah animasi berjalan sekali (opsional)
                 // observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    // --- MULAI APLIKASI ---
    if (supabaseClient) {
        console.log("Initializing app...");
        handleGuestName();
        createFlowers();
        // Fungsi utama (fetchInitialData) sekarang dipanggil di dalam onAuthStateChange
    } else {
        console.error("Supabase client is not available. App initialization aborted.");
        if(loadingIndicator) loadingIndicator.innerHTML = '<p class="text-red-500">Koneksi ke Supabase gagal. Tidak bisa memulai aplikasi.</p>';
    }
</script>

</body>
</html>

